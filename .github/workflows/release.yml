name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        type: string
      draft:
        description: "Create as draft release"
        required: false
        type: boolean
        default: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # Prepare Release
  # ============================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_id: ${{ steps.create-release.outputs.id }}
      upload_url: ${{ steps.create-release.outputs.upload_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --latest --strip header
        env:
          OUTPUT: CHANGELOG.md
        continue-on-error: true

      - name: Create GitHub Release
        id: create-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Notive v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.content || 'Release notes will be added manually.' }}
          draft: ${{ inputs.draft }}
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Build Linux x86_64
  # ============================================
  build-linux-x64:
    name: Build Linux (x86_64)
    runs-on: ubuntu-22.04
    needs: prepare
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target
          cache-on-failure: true

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            libsoup-3.0-dev \
            patchelf \
            squashfs-tools

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          releaseId: ${{ needs.prepare.outputs.release_id }}
          args: --target x86_64-unknown-linux-gnu

  # ============================================
  # Build Linux aarch64
  # ============================================
  build-linux-arm64:
    name: Build Linux (aarch64)
    runs-on: ubuntu-22.04
    needs: prepare
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target
          cache-on-failure: true

      - name: Install cross-compilation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            libc6-dev-arm64-cross \
            patchelf \
            squashfs-tools

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app (cross-compile)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          CC: aarch64-linux-gnu-gcc
          CXX: aarch64-linux-gnu-g++
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig
          PKG_CONFIG_ALLOW_CROSS: 1
        with:
          releaseId: ${{ needs.prepare.outputs.release_id }}
          args: --target aarch64-unknown-linux-gnu --bundles deb,appimage
        continue-on-error: true

  # ============================================
  # Build Flatpak
  # ============================================
  build-flatpak:
    name: Build Flatpak
    runs-on: ubuntu-latest
    needs: prepare
    container:
      image: bilelmoussaoui/flatpak-github-actions:gnome-47
      options: --privileged
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: notive.flatpak
          manifest-path: flatpak/io.github.notive.Notive.yml
          cache-key: flatpak-builder-${{ github.sha }}
        continue-on-error: true

      - name: Upload Flatpak to release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          files: notive.flatpak
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Build Snap
  # ============================================
  build-snap:
    name: Build Snap
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Snap
        uses: snapcore/action-build@v1
        id: snapcraft
        continue-on-error: true

      - name: Upload Snap to release
        if: steps.snapcraft.outcome == 'success'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          files: ${{ steps.snapcraft.outputs.snap }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Generate Update Manifest
  # ============================================
  update-manifest:
    name: Generate Update Manifest
    runs-on: ubuntu-latest
    needs: [prepare, build-linux-x64, build-linux-arm64]
    if: always() && needs.build-linux-x64.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          tag: v${{ needs.prepare.outputs.version }}
          fileName: "*.sig"
          out-file-path: signatures
        continue-on-error: true

      - name: Generate latest.json
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          SIG_FILE="signatures/notive_${VERSION}_amd64.AppImage.sig"
          if [ -f "$SIG_FILE" ]; then
            # Read signature file and escape for JSON
            SIGNATURE=$(cat "$SIG_FILE" | jq -Rs .)
          else
            SIGNATURE="\"\""
          fi
          cat << EOF > latest.json
          {
            "version": "${VERSION}",
            "notes": "See the changelog at https://github.com/${{ github.repository }}/releases/tag/v${VERSION}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "linux-x86_64": {
                "signature": ${SIGNATURE},
                "url": "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/notive_${VERSION}_amd64.AppImage"
              }
            }
          }
          EOF

      - name: Upload update manifest
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          files: latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Publish Release
  # ============================================
  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [prepare, build-linux-x64, update-manifest]
    if: always() && needs.build-linux-x64.result == 'success' && !inputs.draft
    steps:
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Notify on Failure
  # ============================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs:
      [prepare, build-linux-x64, build-linux-arm64, build-flatpak, build-snap]
    if: failure()
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;

            await github.rest.issues.create({
              owner,
              repo,
              title: `Release build failed for v${{ needs.prepare.outputs.version }}`,
              body: `The release workflow failed. Please check the [workflow run](${runUrl}) for details.`,
              labels: ['bug', 'ci']
            });
